pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
-- main
f=false
t=true

prjctls={}
enemies={}
objects={}

function i(o) o.init(o) end
function u(o) o.update(o) end
function d(o) o.draw(o) end

function _init()
	cls()
	--ship(x,y,sprt,w,h,hlth,wep)
	weps={
		wep()
	}
	ships={
		ship(-128,-128,5,1,1,1,weps[1])
	}
	
	plyr=ship(56,112,1,2,2,1,weps[1])
	plyr.update=ctrl
	spwn=spawner()
	spwn.init()
	--add(enemies,ships[1])
	--enemies[1].x=64
	--enemies[1].y=64
end

function _update60()
	plyr.update(plyr)
	spwn.update(spwn)
	foreach(prjctls,u)
	foreach(enemies,u)
end

function _draw()
 cls()
 --print(enemies[1].sequ)
	plyr.draw(plyr)
	foreach(prjctls,d)
	foreach(enemies,d)
end
-->8
-- classes
function ship(x,y,sprt,w,h,hlth,wep)
	local c={}
	c.x=x
	c.y=y
	c.hv=0
	c.vv=0
	c.sprt=sprt
	c.w=w
	c.h=h
	c.mirr=false
	c.hlth=hlth
	c.flsh=0
	c.wep=wep
	c.flag=fget(c.sprt)
	c.wep.flag=~c.flag
	c.sequ=0
	
	c.init=function(o) end
	
	c.update=function(o)
		if o.sequ==1 then
			seq_a(o)
		elseif o.sequ==2 then
			seq_b(o)
		end
	end
	
	c.draw=function(o) 
		if o.flsh>0 then
			for i=1,15 do pal(i,7) end
			o.flsh-=1
			if o.flsh==1 then
				o.isdead(o)
			end
		end
		spr(o.sprt,o.x+o.flsh*(rnd(2)-1),
													o.y+o.flsh*(rnd(2)-1),
													o.w,o.h,o.mirr,false)
		pal()
	end
	
	c.fire = function(o)
		o.wep.fire(o.wep,o.x+7,o.y)
	end
	c.dmg = function(o,dmg)
		o.hlth-=dmg
		o.flsh=3
	end
	c.isdead = function(o)
		if o.hlth<=0 then
			if o.flag==2 then
				del(enemies,o)
			elseif o.flag==4 then
				del(objects,o)
			elseif o.flag==1 then
				o=nil
			end
		end
	end
	return c
end

function wep()
	local c={}
	c.dmg=1
	c.size=2
	c.col=8
	c.spd=1
	c.chg=f
	c.flag=nil
	
	c.init=function() end
	c.fire=function(o,x,y) 
		add(prjctls,proj(x,y,o.dmg,o.flag,nil))
	end
	
	return c
end

function proj(x,y,dmg,flag,targ)
	local c={}
	c.x=x
	c.y=y
	c.dmg=dmg
	c.flag=flag
	c.targ=targ
	
	c.update=function(o) 
		o.y-=3
		
		for e in all(enemies) do
			if coll(o,e) then
				if fget(e.sprt)&o.flag>0 then
					e.dmg(e,o.dmg)
					del(prjctls,o)
				end
			end
		end
	end
	
	c.draw=function(o)
		circfill(o.x,o.y,2,8)
	end
	return c
end

function spawner()
	local c={}
	c.waves={}
	
	c.init=function(o,l)
	for i=0,1 do
		for y=120,127 do
			x=120+i*4
			local char=sget(x,y)
			if char>0 then
				local enmy=ships[1]
				local sequ=sget(x+1,y)
				local stmp=hexd({sget(x+2,y),
															sget(x+3,y)})
				enmy.sequ=sequ
				add(enemies,enmy)
				print(enemies[1].sequ)
				if #enemies==2 then
				print(enemies[2].sequ)
				end
			end
		end
	end
	end
	
	c.update=function(o)
		foreach(waves,u)
	end
	
	return c
end
-->8
-- override
function ctrl(o)
	local hm=btoi(btn(➡️))-btoi(btn(⬅️))
	local vm=btoi(btn(⬇️))-btoi(btn(⬆️))
	o.hv=lerp(o.hv,hm,0.04)
	o.vv=lerp(o.vv,vm,0.04)
	if btnp(⬅️) and dtap(⬅️) then
	o.hv=-1.5
	elseif btnp(➡️) and dtap(➡️) then
	o.hv=1.5
	elseif btnp(⬆️) and dtap(⬆️) then
	o.vv=-1.5
	elseif btnp(⬇️) and dtap(⬇️) then
	o.vv=1.5
	end
	o.x=min(112,max(0,o.x+o.hv))
	o.y+=o.vv
	
	if abs(o.hv)>0.2 then
		o.sprt=3
		if o.hv>0 then
			o.mirr=true
		else
			o.mirr=false
		end
	else
		o.sprt=1
	end
	
	if (btnp(❎)or btnp(🅾️)) then
		o.fire(o)
	end
end
-->8
-- util
function btoi(b)
if b then return 1 end
return 0
end

function lerp(a,b,t)
return a+(b-a)*t
end

prvb={false,false,false,
false,false,false}
function btnp(butn)
	if btn(butn) then
		if prvb[butn+1]==true then
			return false
		else
			prvb[butn+1]=true
			return true
		end
	else
		prvb[butn+1]=false
	end
end

tapd={time(),
						time(),
						time(),
						time()}
function dtap(butn)
	if tapd[butn+1] > time()-0.2 then
		tapd[butn+1]=time()
		return true
	else
		tapd[butn+1]=time()
		return false
	end
end

function coll(proj,obj)
	if proj.x>obj.x and
				proj.x<obj.x+obj.w*8 and
				proj.y>obj.y and
				proj.y<obj.y+obj.h*8 then
				return true
	end
	return false
end

function hexd(hex)
	local dec=0
	local i=0
	for h in all(hex) do
		dec+=max(1,(i*16))*h
		i+=1
	end
	return dec
end

-->8
-- sequences
function seq_a(o)
	o.x=64+sin(time())*10
	o.y=64
end

function seq_b(o)
	o.x=32
	o.y=64
end

__gfx__
00000000000000000000000000000000000000000800008000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000009000000900000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000000000cc00000000000000c00000000a0aaaa0a00000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000000000cc00000000000000cc00000009995599900000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000cccc000000000000ccc0000000a095590a00000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000c11c000000000000111c0000009985589900000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000c1771c000000000017711000000a080080a00000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000c1771c000000000c17711c000000080080000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000cc177771cc000000cc77771cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000cccc177771cccc000ccc77771cccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000c117711c00000000c17711c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000cc11cc0000000000c111c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000cccc000000000000cccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000cc00cc00000000000c0cc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000c00cc00c000000000c0c00c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011200000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012010000
__gff__
0001010101020000000000000000000000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
